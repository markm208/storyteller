<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/st-styles.css">
    <style>

        .playbackWindow {
            height: calc(100vh - 160px);
            /* overflow-y: scroll; */
        }
        
        .tabHeight {
            height: 40px;
        }

        /* Create an active/current tablink class */
        .tab button.active {
        background-color: #ccc;
        }
        /* Style the tab content */
        .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
        }
        .highlight {
            position:absolute;
            z-index:20; /* place in a layer above anything with a lower z-index */
            background-color:limegreen;
            opacity: 20%;
        }

    </style>

    <title>Experimental Playback UI</title>
    </head>
    <h5>Storyteller</h5>
    <body>
        <div class="container-fluid">
            <!--Create Tabs-->
            <div class="tab">
                <ul class="nav nav-tabs" id="tabsList">
                    <li class="nav-item tabHeight">
                        <a class="nav-link active" href="#Playback" role="tab" data-toggle="tab" id="FirstTabLabel"><p><br></p></a>
                    </li>
                </ul>
            </div>

            <!-- Content div for the tabs -->
            <div class="tab-content" id="tabContent">
                <div id="Playback" class="tab-pane active">
                    <div id="playbackWindow" class="playbackWindow"></div>
                </div>
            </div>

            <!-- minimal controls -->
            <div id="playbackControls">
                <input type="range" id="playbackSlider" min="0" value="0" class="custom-range"/>
                <button id="stepBackOne" class="btn btn-light">&lt;</button>
                <button id="stepForwardOne" class="btn btn-light">&gt;</button>
                <button id="restartButton" class="btn btn-danger">Restart</button>
                <button id="highlightButton" class="btn btn-success">Add Highlight</button>
            </div>    
        </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ext-modelist.js" type="text/javascript" charset="utf-8"></script>
   
    <!-- playback specific js files -->
    <script src="/js/playbackInit.js"></script>
    <script src="/js/playbackEventFunctions.js"></script>
    <script src="/js/aceEditorManager.js"></script>
    <script src="/js/ext/md5.min.js"></script> <!-- md5 https://github.com/blueimp/JavaScript-MD5 https://en.gravatar.com/site/implement/hash/ https://en.gravatar.com/site/implement/images/-->
    <script src="/js/ext/jszip.min.js"></script> <!-- jszip https://stuk.github.io/jszip/ -->

    <script>
        var allEditors = {};
        var editor = CreateAceEditor("playbackWindow", "","" );    

        var eventsObject = {};

        //import the Range type from ace (don't use the built in browser Range type)
        const Range = ace.require('ace/range').Range;

        //holds the ids of all the markers (highlights)
        let allHighlights = [];

        //keeps track of the number of created tabs
        var numFilesCreated = 0;

        //stores the currently active tab and content-pane,
        //this is used to automatically change focus when new tabs are created
        var currentActiveTab = document.getElementById("FirstTabLabel");
        var currentActiveContent = document.getElementById("Playback");

        //indicates whether the change can from the textarea not editing in ace
        let changeOutsideEditor = false;
        
        //the position of the event to play next in the forward direction
        //this refers to an object loaded in the script above, 'eventsObject'
        //which has a property called 'events' which is an array of storyteller
        //events 
        let nextEventPosition = 0;
        //DEBUG
        //console.log(`There are ${eventsObject.events.length} events in the array`);

        document.addEventListener("DOMContentLoaded", event => {

          getAllEvents();
          console.log("After function return:");
          console.log(eventsObject);

          //get the controls
          const stepBackOne = document.getElementById("stepBackOne");
          const stepForwardOne = document.getElementById("stepForwardOne");
          const restartButton = document.getElementById("restartButton");
          const playbackSlider = document.getElementById("playbackSlider");
          const highlightButton = document.getElementById("highlightButton");

          //Get references to the tabs and where the tabs get their content
          const tabsList = document.getElementById("tabsList");
          const tabContent = document.getElementById("tabContent");
          //set the max slider value
          playbackSlider.setAttribute("max", eventsObject.events.length);
          
          //add event handlers for clicking the buttons
          stepBackOne.addEventListener("click", event => {
              step(-1);
          });

          stepForwardOne.addEventListener("click", event => {
              step(1);
          });

          //The restart will be depreciated soon
          restartButton.addEventListener("click", event => {
              
              //reset the next event and the slider
              nextEventPosition = 0;
              playbackSlider.value = 0;

              //for measuring which approach is faster
              //get the starting timestamp
              const t0 = performance.now();

              editor.setValue("");

              //get the ending timestamp
              const t1 = performance.now();

              //print the duration in ms
              console.log(`Reset took: ${(t1 - t0)} ms`);
          });

          //add event handler to listen for changes to the slider
          playbackSlider.addEventListener("input", event => {
              //DEBUG
              // console.log(`slide: ${playbackSlider.value}`);
              
              //take the slider value and subtract the next event's position
              step(playbackSlider.value - nextEventPosition);
          });

          highlightButton.addEventListener("click", event =>{
              //get the selected code
              //const selection = editor.getSession().getSelection().getRange();
              const selections = editor.getSession().getSelection().getAllRanges();

              //clear any existing highlights
              clearHighlights();
              
              for (let i = 0; i < selections.length; i++){
                  //add the highlight to the selected code
                  addHighlight(selections[i].start.row, selections[i].start.column, selections[i].end.row, selections[i].end.column);
              }
          });
        });

        function step(numSteps) {
            //move forward
            if(numSteps > 0) {
                stepForward(numSteps);
            } else if(numSteps < 0) { //move backward
                stepBackward(-numSteps);
            } //else- no need to move at all
            
            //update the position of the slider
            playbackSlider.value = nextEventPosition;
        }

        function stepForward(numSteps) {
            //if there is room to move in the forward direction
            if(nextEventPosition < eventsObject.events.length) {
                //holds the next event to animate
                let nextEvent;

                //timing for debug purposes
                //const t0 = performance.now();

                //go through the requested number of steps
                for(let i = 0;i < numSteps;i++) {
                    //grab the next event to animate
                    nextEvent = eventsObject.events[nextEventPosition];

                    //check the event type and call the corresponding function for that event type
                    switch (nextEvent.type)
                    {
                        case 'INSERT':
                        //call the insertEvent function found in playbackEventFunctions.js
                        insertEvent(nextEvent);
                        break;

                        case 'DELETE':
                        //call the deleteEvent function found in playbackEventFunctions.js
                        deleteEvent(nextEvent);
                        break;

                        case 'CREATE FILE':
                        //call the createFileEvent function found in playbackEventFunctions.js
                        createFileEvent(nextEvent);
                        break;
                    }
                    
                    //move the next event
                    nextEventPosition++;

                    //if we played the last event
                    if(nextEventPosition === eventsObject.events.length) {
                        break;
                    }
                }

                //const t1 = performance.now();
                //console.log(`step forward took: ${t1-t0} ms`);
            }
        }

        function stepBackward(numSteps) {
            //if there is room to move backwards
            if(nextEventPosition > 0) {
                //holds the next event to animate
                let nextEvent;

                //to account for the fact that nextEventPosition always 
                //refers to the next event to animate in the forward 
                //direction I move it back by one position
                nextEventPosition--;

                //go through the requested number of steps
                for(let i = 0;i < numSteps;i++) {
                    //grab the next event to de-animate
                    nextEvent = eventsObject.events[nextEventPosition];

                    //check the event type and call the corresponding function for that event type
                    switch (nextEvent.type)
                    {
                        case 'INSERT':
                        //call the deleteEvent function found in playbackEventFunctions.js
                        deleteEvent(nextEvent);
                        break;

                        case 'DELETE':
                        //call the insertEvent function found in playbackEventFunctions.js
                        insertEvent(nextEvent);
                        break;

                        case 'CREATE FILE':
                        //call the deleteFileEvent function found in playbackEventFunctions.js
                        deleteFileEvent(nextEvent);
                        break;
                    }

                    //move to the previous event
                    nextEventPosition--;

                    //if we just played back the first event and then decremented
                    if(nextEventPosition < 0) {
                        break;
                    }
                }

                //after moving backwards, account for the fact that this
                //always refers to the next index to animate in the forward
                //direction
                nextEventPosition++;
            }
        }
    </script>
  </body>
</html>
